import React, { useState, useEffect } from 'react';
// Import các hàm cần thiết từ Firebase SDK
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updatePassword, sendPasswordResetEmail } from 'firebase/auth';
import { getFirestore, collection, doc, addDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, where, serverTimestamp, getDocs } from 'firebase/firestore';
import { getStorage, ref, uploadBytes, getDownloadURL, listAll, deleteObject } from 'firebase/storage';

// --- BƯỚC QUAN TRỌNG ---
// Dán cấu hình Firebase của bạn đã lấy từ Console vào đây.
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Khởi tạo các dịch vụ Firebase một lần duy nhất
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// --- COMPONENT CHÍNH CỦA ỨNG DỤNG ---
export default function App() {
    const [currentUser, setCurrentUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, 'users', user.uid);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    setCurrentUser({ uid: user.uid, ...docSnap.data() });
                } else {
                    console.error("Không tìm thấy thông tin người dùng!");
                    signOut(auth);
                }
            } else {
                setCurrentUser(null);
            }
            setLoading(false);
        });
        return () => unsubscribe();
    }, []);

    const handleLogin = async (email, password) => {
        setError('');
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (err) {
            setError('Email hoặc mật khẩu không chính xác.');
        }
    };

    const handleLogout = () => {
        signOut(auth);
    };

    if (loading) {
        return <div className="flex items-center justify-center min-h-screen bg-gray-100 font-sans">Đang tải ứng dụng...</div>;
    }

    return (
        <div className="font-sans">
            {!currentUser ? (
                <LoginScreen handleLogin={handleLogin} error={error} setError={setError} />
            ) : (
                <Dashboard user={currentUser} onLogout={handleLogout} />
            )}
        </div>
    );
}

// --- MÀN HÌNH ĐĂNG NHẬP VÀ QUÊN MẬT KHẨU ---
function LoginScreen({ handleLogin, error, setError }) {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');

    const handleForgotPassword = async () => {
        if (!email) {
            setError("Vui lòng nhập email của bạn để cấp lại mật khẩu.");
            return;
        }
        try {
            await sendPasswordResetEmail(auth, email);
            alert(`Một email hướng dẫn cấp lại mật khẩu đã được gửi đến ${email}. Vui lòng kiểm tra hộp thư của bạn.`);
            setError('');
        } catch (err) {
            setError("Email không tồn tại trong hệ thống.");
            console.error(err);
        }
    };

    const onFormSubmit = (e) => {
        e.preventDefault();
        handleLogin(email, password);
    }

    return (
        <div className="min-h-screen bg-gray-100 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
            <div className="sm:mx-auto sm:w-full sm:max-w-md">
                <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">Hệ thống Quản lý Công việc</h2>
            </div>
            <div className="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
                <div className="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
                    <form className="space-y-6" onSubmit={onFormSubmit}>
                        <div>
                            <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email</label>
                            <input id="email" name="email" type="email" required value={email} onChange={e => setEmail(e.target.value)}
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                        </div>
                        <div>
                            <label htmlFor="password" className="block text-sm font-medium text-gray-700">Mật khẩu</label>
                            <input id="password" name="password" type="password" required value={password} onChange={e => setPassword(e.target.value)}
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                        </div>
                        {error && <p className="text-red-500 text-sm">{error}</p>}
                        <div className="flex items-center justify-between">
                            <div className="text-sm">
                                <button type="button" onClick={handleForgotPassword} className="font-medium text-indigo-600 hover:text-indigo-500">
                                    Quên mật khẩu?
                                </button>
                            </div>
                        </div>
                        <div>
                            <button type="submit" className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
                                Đăng nhập
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    );
}

// --- BẢNG ĐIỀU KHIỂN CHÍNH ---
function Dashboard({ user, onLogout }) {
    // State để chuyển đổi giữa màn hình Bảng công việc và Hồ sơ
    const [view, setView] = useState('tasks'); // 'tasks' or 'profile'

    return (
        <div className="min-h-screen bg-gray-50">
            <header className="bg-white shadow-sm sticky top-0 z-20">
                <div className="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                    <div>
                        <h1 className="text-2xl font-bold text-gray-900">
                            {view === 'tasks' ? 'Bảng điều khiển' : 'Hồ sơ Cá nhân'}
                        </h1>
                        <p className="text-sm text-gray-600">Chào, {user.fullName} ({user.title})</p>
                    </div>
                    <div className="flex items-center gap-4">
                        <button onClick={() => setView(view === 'tasks' ? 'profile' : 'tasks')}
                            className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">
                             {view === 'tasks' ? 'Hồ sơ của tôi' : 'Bảng công việc'}
                        </button>
                        <button onClick={onLogout} className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">
                            Đăng xuất
                        </button>
                    </div>
                </div>
            </header>
            <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                {view === 'profile' ? (
                    <ProfilePage user={user} />
                ) : user.role === 'manager' ? (
                    <ManagerView manager={user} />
                ) : (
                    <MemberView member={user} />
                )}
            </main>
        </div>
    );
}


// --- TRANG HỒ SƠ CÁ NHÂN ---
function ProfilePage({ user }) {
    const [newPassword, setNewPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [message, setMessage] = useState({ type: '', content: '' });
    const [files, setFiles] = useState([]);
    const [isUploading, setIsUploading] = useState(false);

    // Lấy danh sách tệp tin cá nhân
    useEffect(() => {
        const filesRef = ref(storage, `profiles/${user.uid}`);
        listAll(filesRef)
            .then(res => {
                const filePromises = res.items.map(itemRef => getDownloadURL(itemRef).then(url => ({ name: itemRef.name, url })));
                Promise.all(filePromises).then(setFiles);
            })
            .catch(err => console.error("Lỗi khi lấy danh sách tệp: ", err));
    }, [user.uid]);

    const handleChangePassword = async (e) => {
        e.preventDefault();
        if (newPassword !== confirmPassword) {
            setMessage({ type: 'error', content: 'Mật khẩu xác nhận không khớp.' });
            return;
        }
        if (newPassword.length < 6) {
            setMessage({ type: 'error', content: 'Mật khẩu phải có ít nhất 6 ký tự.' });
            return;
        }
        try {
            await updatePassword(auth.currentUser, newPassword);
            setMessage({ type: 'success', content: 'Đổi mật khẩu thành công!' });
            setNewPassword('');
            setConfirmPassword('');
        } catch (error) {
            setMessage({ type: 'error', content: 'Đã xảy ra lỗi. Vui lòng đăng xuất và đăng nhập lại trước khi đổi mật khẩu.' });
            console.error("Lỗi khi đổi mật khẩu: ", error);
        }
    };
    
    const handleFileUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setIsUploading(true);
        const fileRef = ref(storage, `profiles/${user.uid}/${file.name}`);
        try {
            await uploadBytes(fileRef, file);
            const url = await getDownloadURL(fileRef);
            setFiles(prevFiles => [...prevFiles, { name: file.name, url }]);
            alert("Tải tệp lên thành công!");
        } catch (error) {
            console.error("Lỗi khi tải tệp: ", error);
            alert("Đã xảy ra lỗi khi tải tệp.");
        } finally {
            setIsUploading(false);
        }
    };

    return (
        <div className="space-y-8">
            {/* Phần đổi mật khẩu */}
            <div className="bg-white p-6 rounded-lg shadow">
                <h3 className="text-lg font-medium mb-4">Đổi mật khẩu</h3>
                <form onSubmit={handleChangePassword} className="space-y-4 max-w-sm">
                    {/* ... form fields ... */}
                     <div>
                        <label className="block text-sm font-medium">Mật khẩu mới</label>
                        <input type="password" value={newPassword} onChange={e => setNewPassword(e.target.value)} required
                               className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"/>
                    </div>
                     <div>
                        <label className="block text-sm font-medium">Xác nhận mật khẩu mới</label>
                        <input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} required
                               className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"/>
                    </div>
                    <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-md">Cập nhật mật khẩu</button>
                    {message.content && (
                        <p className={`text-sm ${message.type === 'error' ? 'text-red-500' : 'text-green-500'}`}>{message.content}</p>
                    )}
                </form>
            </div>
            {/* Phần hồ sơ cá nhân */}
            <div className="bg-white p-6 rounded-lg shadow">
                <h3 className="text-lg font-medium mb-4">Hồ sơ cá nhân</h3>
                <div className="mb-4">
                    <label htmlFor="file-upload" className="cursor-pointer px-4 py-2 bg-green-600 text-white rounded-md">
                        {isUploading ? "Đang tải lên..." : "+ Tải lên tệp mới"}
                    </label>
                    <input id="file-upload" type="file" className="hidden" onChange={handleFileUpload} disabled={isUploading} />
                </div>
                <ul className="space-y-2">
                    {files.map(file => (
                        <li key={file.name} className="flex justify-between items-center p-2 border rounded-md">
                            <a href={file.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">{file.name}</a>
                        </li>
                    ))}
                    {files.length === 0 && <p className="text-gray-500">Chưa có hồ sơ nào được lưu trữ.</p>}
                </ul>
            </div>
        </div>
    );
}

// ... Các component còn lại (ManagerView, MemberView, TaskItem, CreateTaskModal) giữ nguyên cấu trúc
// nhưng cần một vài chỉnh sửa nhỏ để tích hợp chức năng mới nếu cần.

// --- CÁC COMPONENT KHÁC (GIỮ NGUYÊN HOẶC CHỈNH SỬA NHỎ) ---
// (Dán các component ManagerView, MemberView, TaskItem, CreateTaskModal từ phiên bản trước vào đây)
// --- GIAO DIỆN CỦA TRƯỞNG PHÒNG ---
function ManagerView({ manager }) {
    const [tasks, setTasks] = useState([]);
    const [users, setUsers] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [isModalOpen, setIsModalOpen] = useState(false);

    // Lấy dữ liệu công việc và thành viên từ Firestore
    useEffect(() => {
        const tasksQuery = query(collection(db, "tasks"));
        const unsubscribeTasks = onSnapshot(tasksQuery, (snapshot) => {
            const tasksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setTasks(tasksData);
            setIsLoading(false);
        });

        const fetchUsers = async () => {
            const usersQuery = query(collection(db, "users"), where("role", "==", "member"));
            const usersSnapshot = await getDocs(usersQuery);
            const usersData = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setUsers(usersData);
        };
        fetchUsers();
        return () => unsubscribeTasks();
    }, []);

    const handleCreateTask = async (newTask) => {
        try {
            await addDoc(collection(db, 'tasks'), {
                ...newTask,
                createdAt: serverTimestamp(),
                status: 'pending',
                progress: 0,
            });
            setIsModalOpen(false);
        } catch (error) {
            console.error("Lỗi khi tạo công việc: ", error);
            alert("Đã xảy ra lỗi khi giao việc.");
        }
    };

    const handleDeleteTask = async (taskId) => {
        if (window.confirm("Bạn có chắc chắn muốn xóa công việc này?")) {
            try {
                await deleteDoc(doc(db, 'tasks', taskId));
            } catch (error) {
                console.error("Lỗi khi xóa công việc: ", error);
            }
        }
    };
    
    const handleResetPassword = async (userEmail) => {
         if (window.confirm(`Bạn có chắc chắn muốn gửi email cấp lại mật khẩu cho ${userEmail}?`)) {
            try {
                await sendPasswordResetEmail(auth, userEmail);
                alert(`Yêu cầu đã được gửi. ${userEmail} sẽ nhận được email hướng dẫn.`);
            } catch(error) {
                alert("Đã xảy ra lỗi. Email này có thể không tồn tại.");
                console.error("Lỗi khi cấp lại mật khẩu: ", error);
            }
        }
    }

    return (
        <div>
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-semibold">Quản lý Công việc</h2>
                <button onClick={() => setIsModalOpen(true)} className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">
                    + Giao việc mới
                </button>
            </div>
            
            <div className="bg-white shadow overflow-hidden sm:rounded-md">
                <ul role="list" className="divide-y divide-gray-200">
                    {isLoading ? <li className="p-4 text-center">Đang tải...</li> :
                     tasks.map(task => (
                        <TaskItem key={task.id} task={task} users={users} isManager={true} onDelete={handleDeleteTask} onResetPassword={handleResetPassword}/>
                    ))}
                </ul>
            </div>

            {isModalOpen && (
                <CreateTaskModal 
                    onClose={() => setIsModalOpen(false)} 
                    members={users} 
                    onCreate={handleCreateTask}
                    managerId={manager.uid}
                />
            )}
        </div>
    );
}

// --- GIAO DIỆN CỦA THÀNH VIÊN ---
function MemberView({ member }) {
    const [allTasks, setAllTasks] = useState([]);
    const [users, setUsers] = useState([]);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        const tasksQuery = query(collection(db, "tasks"));
        const unsubscribeTasks = onSnapshot(tasksQuery, (snapshot) => {
            const tasksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setAllTasks(tasksData);
            setIsLoading(false);
        });

        const fetchUsers = async () => {
            const usersSnapshot = await getDocs(collection(db, "users"));
            const usersData = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setUsers(usersData);
        };
        fetchUsers();
        return () => unsubscribeTasks();
    }, []);

    const myTasks = allTasks.filter(task => task.assigneeId === member.uid);
    const otherTasks = allTasks.filter(task => task.assigneeId !== member.uid);

    return (
        <div>
            <h2 className="text-xl font-semibold mb-6">Công việc của tôi</h2>
            <div className="bg-white shadow overflow-hidden sm:rounded-md mb-8">
                <ul role="list" className="divide-y divide-gray-200">
                    {isLoading ? <li className="p-4 text-center">Đang tải...</li> : 
                     myTasks.length > 0 ? myTasks.map(task => (
                        <TaskItem key={task.id} task={task} users={users} />
                    )) : <li className="p-4 text-gray-500">Bạn không có công việc nào.</li>}
                </ul>
            </div>

            <h3 className="text-lg font-medium text-gray-800 mb-4">Tiến độ của thành viên khác</h3>
            <div className="bg-white shadow overflow-hidden sm:rounded-md">
                 <ul role="list" className="divide-y divide-gray-200">
                    {isLoading ? <li className="p-4 text-center">Đang tải...</li> : 
                    otherTasks.map(task => (
                        <TaskItem key={task.id} task={task} users={users} isOtherMember={true} />
                    ))}
                </ul>
            </div>
        </div>
    );
}

// --- CÁC COMPONENT TÁI SỬ DỤNG ---
function TaskItem({ task, users, isManager = false, isOtherMember = false, onDelete, onResetPassword }) {
    const assignee = users.find(u => u.id === task.assigneeId);
    const dueDate = task.dueDate?.toDate(); 
    const isOverdue = dueDate && new Date() > dueDate && task.status !== 'completed';

    const getStatusInfo = () => {
        if (task.status === 'completed') return { text: 'Hoàn thành', color: 'bg-green-100 text-green-800' };
        if (isOverdue) return { text: 'Quá hạn', color: 'bg-red-100 text-red-800' };
        if (task.status === 'in-progress') return { text: 'Đang làm', color: 'bg-blue-100 text-blue-800' };
        return { text: 'Chờ thực hiện', color: 'bg-gray-100 text-gray-800' };
    };
    const statusInfo = getStatusInfo();
    
    return (
         <li className="px-4 py-4 sm:px-6">
            <div className="flex items-center justify-between">
                <p className="text-md font-medium text-indigo-600 truncate">{task.title}</p>
                <p className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusInfo.color}`}>{statusInfo.text}</p>
            </div>
            <div className="mt-2 sm:flex sm:justify-between">
                 <div className="sm:flex items-center gap-4">
                    <p className="flex items-center text-sm text-gray-500">
                         <svg className="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" /></svg>
                        {assignee ? assignee.fullName : 'Không xác định'}
                    </p>
                    {isManager && assignee && (
                        <button onClick={() => onResetPassword(assignee.email)} className="text-xs text-gray-500 hover:text-indigo-600">(Cấp lại mật khẩu)</button>
                    )}
                </div>
                {dueDate && (
                <div className="mt-2 flex items-center text-sm text-gray-500 sm:mt-0">
                    <svg className="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd" /></svg>
                    <p>Hạn chót: <time dateTime={dueDate.toISOString().split('T')[0]}>{dueDate.toLocaleDateString('vi-VN')}</time></p>
                </div>
                )}
            </div>
            <div className="mt-2 w-full bg-gray-200 rounded-full h-2.5"><div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${task.progress || 0}%` }}></div></div>
             {!isOtherMember && (
                <div className="mt-4 flex gap-4">
                    {isManager ? (<><button className="text-sm text-blue-600 hover:text-blue-800">Sửa</button><button onClick={() => onDelete(task.id)} className="text-sm text-red-600 hover:text-red-800">Xóa</button></>) 
                    : (<button className="text-sm px-3 py-1 bg-indigo-500 text-white rounded-md hover:bg-indigo-600" disabled={task.status === 'completed'}>{task.status === 'completed' ? 'Đã báo cáo' : 'Cập nhật & Báo cáo'}</button>)}
                </div>
             )}
        </li>
    );
}

function CreateTaskModal({ onClose, members, onCreate, managerId }) {
    const [title, setTitle] = useState('');
    const [description, setDescription] = useState('');
    const [assigneeId, setAssigneeId] = useState(members[0]?.id || '');
    const [dueDate, setDueDate] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        onCreate({ title, description, assigneeId, dueDate: new Date(dueDate), assignerId: managerId });
    };

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
            <div className="relative p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
                 <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-medium">Giao công việc mới</h3>
                    <button onClick={onClose} className="text-gray-500 text-2xl hover:text-gray-800">&times;</button>
                </div>
                <form onSubmit={handleSubmit} className="space-y-4">
                     <div>
                        <label className="block text-sm font-medium">Tiêu đề</label>
                        <input type="text" value={title} onChange={e => setTitle(e.target.value)} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"/>
                    </div>
                     <div>
                        <label className="block text-sm font-medium">Mô tả chi tiết</label>
                        <textarea value={description} onChange={e => setDescription(e.target.value)} rows="3" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Giao cho</label>
                        <select value={assigneeId} onChange={e => setAssigneeId(e.target.value)} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            {members.map(member => (<option key={member.id} value={member.id}>{member.fullName}</option>))}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Hạn chót</label>
                        <input type="date" value={dueDate} onChange={e => setDueDate(e.target.value)} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"/>
                    </div>
                    <div className="flex justify-end gap-4 pt-4">
                        <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button>
                        <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Giao việc</button>
                    </div>
                </form>
            </div>
        </div>
    );
}

